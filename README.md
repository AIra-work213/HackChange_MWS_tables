# Чат-бот для анализа постов

AI-powered чат-бот для анализа данных постов телеком-операторов из VK.

## Команда:
### Название: Domestos team

 - Капитан: Бовина Полина Викторовна (Data engineer & product manager)
 - Участник: Садовой Денис Романович (ML engineer)
 - Участник: Гаспарьян Никита Сергеевич (Data analytic)

## Полезные ссылки

Ссылка на рабочий прототип: http://89.169.189.6:8501

Ссылка на MWS Tables: https://tables.mws.ru/invite/link?token=6104f41ee3b4431eb5046358ee581a86

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ИСТОЧНИКИ ДАННЫХ                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   VK API                                                                     │
│   ├── МТС (-8458649)                                                        │
│   ├── Билайн (-26514504)                                                    │
│   ├── Теле2 (-18098621)                                                     │
│   ├── Йота (-50353992)                                                      │
│   └── Мегафон (-3785)                                                       │
│                                                                              │
│         │                                                                    │
│         ▼                                                                    │
│   ┌─────────────────┐                                                        │
│   │  autoupdate.py  │  ← Парсинг постов (cron: каждый час)                  │
│   │  VKDataCollector│                                                        │
│   └────────┬────────┘                                                        │
│            │                                                                 │
│            │  Извлечение:                                                    │
│            │  • text, title, views, likes, reposts                          │
│            │  • ER (Engagement Rate), Efficiency                            │
│            │  • day_of_week, time_period                                    │
│            │                                                                 │
│            ▼                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                              ХРАНИЛИЩЕ ДАННЫХ                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────┐                               │
│   │           MWS Tables API                │                               │
│   │  https://tables.mws.ru/fusion/v1/...    │                               │
│   │                                         │                               │
│   │  Поля:                                  │                               │
│   │  • post_id, owner_id, title, text       │                               │
│   │  • views, likes, reposts, comments      │                               │
│   │  • ER, Efficiency                       │                               │
│   │  • day_of_week, time_period, post_date  │                               │
│   └─────────────────────────────────────────┘                               │
│            │                                                                 │
│            │  REST API (GET/POST)                                           │
│            ▼                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                              BACKEND (FastAPI)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐     │
│   │   backend.py    │ ───► │    model.py     │ ───► │  fetch_data.py  │     │
│   │   (async API)   │      │   (AI Agent)    │      │  (DB queries)   │     │
│   │   :8000         │      │                 │      │                 │     │
│   └─────────────────┘      └────────┬────────┘      └─────────────────┘     │
│                                     │                                        │
│                                     │  Цикл агента (до 5 итераций):         │
│                                     │  1. Анализ запроса                    │
│                                     │  2. Формирование query к БД           │
│                                     │  3. Получение данных                  │
│                                     │  4. Анализ результатов                │
│                                     │  5. Финальный ответ                   │
│                                     │                                        │
│                                     ▼                                        │
│                            ┌─────────────────┐                              │
│                            │  OpenRouter API │                              │
│                            │  (LLM Model)    │                              │
│                            └─────────────────┘                              │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                              FRONTEND (Streamlit)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────┐                               │
│   │              chat.py                    │                               │
│   │           http://...:8501               │                               │
│   │                                         │                               │
│   │  ┌─────────────────────────────────┐   │                               │
│   │  │  💬 Чат-интерфейс               │   │                               │
│   │  │  • История диалога (session)    │   │                               │
│   │  │  • Контекст памяти              │   │                               │
│   │  │  • Примеры запросов             │   │                               │
│   │  └─────────────────────────────────┘   │                               │
│   └─────────────────────────────────────────┘                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Поток данных

```
Пользователь                     Система
     │                              │
     │  "Топ-5 постов по лайкам"   │
     │ ──────────────────────────► │
     │                              │
     │                   ┌──────────┴──────────┐
     │                   │  1. Streamlit       │
     │                   │     принимает       │
     │                   │     запрос          │
     │                   └──────────┬──────────┘
     │                              │
     │                   ┌──────────┴──────────┐
     │                   │  2. FastAPI         │
     │                   │     async обработка │
     │                   │     (run_in_executor)│
     │                   └──────────┬──────────┘
     │                              │
     │                   ┌──────────┴──────────┐
     │                   │  3. AI Agent        │
     │                   │     формирует       │
     │                   │     JSON query      │
     │                   └──────────┬──────────┘
     │                              │
     │                   ┌──────────┴──────────┐
     │                   │  4. MWS Tables      │
     │                   │     возвращает      │
     │                   │     записи          │
     │                   └──────────┬──────────┘
     │                              │
     │                   ┌──────────┴──────────┐
     │                   │  5. AI Agent        │
     │                   │     анализирует     │
     │                   │     и отвечает      │
     │                   └──────────┬──────────┘
     │                              │
     │  "Вот топ-5 постов: ..."    │
     │ ◄────────────────────────── │
     │                              │
```

---

## Быстрый старт

```bash
make install   # Установка
make run       # Запуск
```

### Предварительно после клонирования нужно создать .env файл с API ключом от openrouter (см. .env.example)

- **Frontend:** http://localhost:8501
- **Backend:** http://localhost:8000

## Команды

| Команда | Описание |
|---------|----------|
| `make install` | Установка Python, venv и зависимостей |
| `make run` | Запуск сервера и фронтенда |
| `make stop` | Остановка приложения |
| `make server` | Запуск только сервера |
| `make frontend` | Запуск только фронтенда |
| `make check` | Проверка установки |
| `make clean` | Удаление venv |

## Структура проекта

```
├── app/
│   └── chat.py              # Streamlit фронтенд (чат-бот)
├── server/
│   ├── backend.py           # FastAPI async сервер
│   ├── model.py             # AI агент с мульти-запросами
│   ├── fetch_data.py        # LangChain tool для запросов к БД
│   ├── insert_data.py       # Загрузка данных из CSV
│   └── autoupdate.py        # Парсер VK (инкрементальное обновление)
├── Makefile                 # Команды сборки/запуска
└── README.md
```

## Примеры запросов

- "Покажи топ-5 постов по лайкам"
- "Сравни эффективность постов утром и вечером"
- "Найди посты с более чем 1000 просмотров"
- "Какой день недели лучший для публикаций?"

## Технологии

| Компонент | Технология |
|-----------|------------|
| Backend | FastAPI, Uvicorn (async) |
| Frontend | Streamlit |
| AI | OpenRouter API, LangChain |
| Database | MWS Tables API |
| Парсинг | VK API, requests |
| Деплой | Linux, Make, pyenv |
